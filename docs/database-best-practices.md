# Database Best Practices

Pingmon プロジェクトにおけるデータベース開発のベストプラクティスガイドです。

> **Note**: このプロジェクトでは、データベース設計・管理に Claude (Anthropic)を活用しています。

## 📚 目次

- [開発環境のセットアップ](#開発環境のセットアップ)
- [マイグレーション開発フロー](#マイグレーション開発フロー)
- [環境別コマンドリファレンス](#環境別コマンドリファレンス)
- [本番デプロイメント](#本番デプロイメント)

---

## 開発環境のセットアップ

### ローカル環境の起動

```bash
# Dockerベースのローカル環境を起動
supabase start

# Supabase Studio（GUI）にアクセス
open http://localhost:54323
```

**利点**:

- 本番環境から完全に独立
- 何度でもリセット可能
- テストデータの自動投入（seed.sql）

### 開発環境の終了

```bash
supabase stop
```

---

## マイグレーション開発フロー

### 推奨ワークフロー

```bash
# 1. ローカル環境を起動
supabase start

# 2. 新しいマイグレーションを作成
supabase migration new add_new_feature

# 3. マイグレーション内容を記述
# supabase/migrations/[timestamp]_add_new_feature.sql

# 4. ローカル環境で適用・テスト
supabase db reset

# 5. 動作確認
# - Supabase Studioでスキーマ確認
# - アプリケーションの動作テスト

# 6. Gitにコミット
git add supabase/migrations/
git commit -m "feat(db): Add new feature"
git push

# 7. 本番環境にデプロイ
supabase db push
```

### 開発のベストプラクティス

- ✅ **ローカルファースト**: 常にローカル環境で十分にテストしてから本番適用
- ✅ **マイグレーションは前進のみ**: ロールバックではなく、新しいマイグレーションで修正
- ✅ **小さな変更を頻繁に**: 大きな変更は複数のマイグレーションに分割
- ✅ **コードレビュー**: 本番適用前にチームメンバーに確認

---

## 環境別コマンドリファレンス

### ローカル環境（開発・テスト用）

| コマンド            | 説明                       | データへの影響    |
| ------------------- | -------------------------- | ----------------- |
| `supabase start`    | ローカル環境を起動         | -                 |
| `supabase db reset` | スキーマをリセット＆再構築 | ✅ すべてリセット |
| `supabase stop`     | ローカル環境を停止         | -                 |

**推奨**: ローカル環境では `reset` を自由に使用してください。

### 本番環境（プロダクション）

| コマンド                    | 説明                   | データへの影響  |
| --------------------------- | ---------------------- | --------------- |
| `supabase db push`          | マイグレーションを適用 | ✅ データは保持 |
| `supabase db pull`          | スキーマ定義を取得     | -               |
| `supabase db diff --linked` | ローカルとの差分を確認 | -               |

**重要**: 本番環境では `push` のみを使用します。

---

## 本番デプロイメント

### デプロイ前チェックリスト

- [ ] ローカル環境で正常に動作することを確認
- [ ] マイグレーションファイルが Git にコミット済み
- [ ] 破壊的変更がないことを確認（カラム削除、型変更など）
- [ ] 他のサービス（Worker、Frontend）への影響を確認
- [ ] チームメンバーに通知

### デプロイ実行

```bash
# マイグレーションを本番環境に適用
supabase db push

# 適用後の確認
supabase db diff --linked
```

### デプロイ後の確認

- [ ] Supabase Studio でスキーマ変更を確認
- [ ] アプリケーションの動作確認
- [ ] エラーログの確認
- [ ] パフォーマンスの確認

---

## Claude 活用について

このプロジェクトでは、データベース設計・マイグレーション開発に Claude (Anthropic)を活用しています。

### Claude との協働フロー

1. **設計相談**: スキーマ設計やパフォーマンス最適化について相談
2. **マイグレーション作成**: SQL の記述とレビュー
3. **ベストプラクティス確認**: 実装方法の妥当性検証
4. **ドキュメント生成**: スキーマドキュメントの自動生成

### 人間と AI の責任分担

**人間（開発者）の責任**:

- ビジネス要件の定義
- 最終的な意思決定
- コマンド実行前の環境確認
- 本番環境への適用判断

**Claude (AI)の責任**:

- 技術的な提案とサポート
- SQL の生成とレビュー
- ベストプラクティスの提示
- ドキュメント作成支援

---

## 便利なコマンド集

### スキーマ確認

```bash
# ローカルと本番の差分を表示
supabase db diff --linked

# 本番スキーマをローカルにプル
supabase db pull
```

### データベース接続

```bash
# ローカル環境に接続
psql postgresql://postgres:postgres@127.0.0.1:54322/postgres
```

### テストデータの管理

テストデータは `supabase/seed.sql` で管理されています。ローカル環境のリセット時に自動で投入されます。

---

## 参考リンク

- [Supabase CLI ドキュメント](https://supabase.com/docs/guides/cli)
- [Supabase マイグレーションガイド](https://supabase.com/docs/guides/cli/local-development)
- [Claude API ドキュメント](https://docs.anthropic.com/)

---

**最終更新**: 2025-10-25
